steps:
  - command:
      - chmod 755 auto/run_tests.sh
      - auto/run_tests.sh
    label: ':package: & :rocket: Run Tests on Dev: VERSION -> ${BUILDKITE_BUILD_NUMBER}'
    # depends_on:
    #   - "build"
    # soft_fail:
    #   - exit_status: "*"
    key: 'run_tests'
    branches: woa-*
    agents:
      queue: 'wo:dev'
    notify:
      - github_commit_status:
          context: 'Unit Tests?'
    # artifact_paths:
    #   - "cypress/results/**/*"
    retry:
      automatic:
        - exit_status: -1
          limit: 1
    env:
      BUILD_VERSION: '${BUILDKITE_BUILD_NUMBER}'
      ENV: 'dev-IntegrationTests'
      SUPERSET_URL: "https://bi-dev.woaharvest.com"

  - command:
      - chmod 755 auto/build.sh
      - auto/build.sh
      - chmod 755 auto/deploy_dev.sh
      - auto/deploy_dev.sh
    label: ':package: & :rocket: Build & Deploy Dev: VERSION -> ${BUILDKITE_BUILD_NUMBER}'
    branches: dev
    agents:
      queue: 'wo:dev'
    retry:
      automatic:
        - exit_status: -1
          limit: 1
    env:
      BUILD_VERSION: '${BUILDKITE_BUILD_NUMBER}'
      ENV: 'dev'
      SUPERSET_URL: "https://bi-dev.woaharvest.com"

  - command:
      - chmod 755 auto/build.sh
      - auto/build.sh
      - chmod 755 auto/deploy_qa.sh
      - auto/deploy_qa.sh
    label: ':package: & :rocket: Build & Deploy QA: VERSION -> ${BUILDKITE_BUILD_NUMBER}'
    branches: release/*
    agents:
      queue: 'wo:qa'
    retry:
      automatic:
        - exit_status: -1
          limit: 1
    env:
      BUILD_VERSION: '${BUILDKITE_BUILD_NUMBER}'
      ENV: 'qa'
      SUPERSET_URL: "https://bi-dev.woaharvest.com"

  - wait

  - block: ':green_button: Deploy to PRE-PROD'
    prompt: 'Deploy WO to PRE-PROD environment?'
    branches: 'master'

  - command:
      - chmod 755 auto/build.sh
      - auto/build.sh
      - chmod 755 auto/deploy_preprod.sh
      - auto/deploy_preprod.sh
    label: ':package: & :rocket: Build & Deploy PRE-PROD: VERSION -> ${BUILDKITE_BUILD_NUMBER}'
    branches: master
    agents:
      queue: 'wo:preprod'
    retry:
      automatic:
        - exit_status: -1
          limit: 1
    env:
      BUILD_VERSION: '${BUILDKITE_BUILD_NUMBER}'
      ENV: 'preprod'
      SUPERSET_URL: "https://bi-dev.woaharvest.com"

  - wait

  - block: ':green_button: Deploy to PROD'
    prompt: 'Deploy WO to PROD environment?'
    branches: 'master'

  - command:
      - chmod 755 auto/build.sh
      - auto/build.sh
      - chmod 755 auto/deploy_prod.sh
      - auto/deploy_prod.sh
    label: ':package: & :rocket: Build & Deploy PROD: VERSION -> ${BUILDKITE_BUILD_NUMBER}'
    branches: master
    agents:
      queue: 'wo:prod'
    retry:
      automatic:
        - exit_status: -1
          limit: 1
    env:
      BUILD_VERSION: '${BUILDKITE_BUILD_NUMBER}'
      ENV: 'prod'
      SUPERSET_URL: "https://bi.woaharvest.com"
